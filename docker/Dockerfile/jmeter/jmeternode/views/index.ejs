<%- include layouts/header.ejs %>
<%- include layouts/message.ejs %>
<div class="table-wrapper">
    <div class="table-title">
        <div class="row">
            <div class="col-sm-6">
                <h2>Manage
                    <b>jmx files</b>
                </h2>
            </div>
            <div class="col-sm-6">
                <a href="http://10.1.1.1:3333/public/files/jmeter-docker%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B9%B3%E5%8F%B0%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3.docx" class="btn btn-warning" data-toggle="modal">
                    <span>说明文档下载</span>
                </a>
                <a href="#addModal" class="btn btn-success" data-toggle="modal">
                    <i class="material-icons">&#xE147;</i>
                    <span>Add New file</span>
                </a>
                <a href="#deleteModal" class="btn btn-danger" data-toggle="modal">
                    <i class="material-icons">&#xE15C;</i>
                    <span>Delete</span>
                </a>
            </div>
        </div>
    </div>
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>
                    <span class="custom-checkbox">
                        <input type="checkbox" id="selectAll">
                        <label for="selectAll"></label>
                    </span>
                </th>
                <th>ID</th>
                <th>Name</th>
                <th>File</th>
                <th>ChangeTime</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
		    <% if (data) { %>
		        <% data.forEach(function(jmx){ %>
                    <tr>
                        <td>
                            <span class="custom-checkbox">
                                <input type="checkbox" id="checkbox1" name="options" value="<%= jmx.id %>">
                                <label for="checkbox1"></label>
                            </span>
                        </td>
                        <td>
                            <%= jmx.id %>
                        </td>
                        <td>
                            <%= jmx.name %>
                        </td>
                        <td>
                            <%= jmx.file %>
                        </td>
                        <td>
                            <%= jmx.changetime %>
                        </td>
											<td>
                                                <div class="dropdown" style="width: 60%;min-width:90px;">
                                                        <button class="btn btn-<% if (jmx.status == "inactive") { %>warning<% } else if(jmx.status == "active") { %>success<% } else { %>danger<% } %> dropdown-toggle" style="width:100%;" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                                                <%= jmx.status %>
                                                          <span class="caret"></span>
                                                        </button>
                                                        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1" style="min-width:100%;">
                                                                <% if (jmx.status != "active" && jmx.user && jmx.status!="wrong") { %>
                                                                    <li><a href="/start/<%= jmx.id %>" style="width:100%; text-align: center;">start</a></li>
                                                                <% } %>
                                                            <% if (jmx.status == "active") { %>
                                                          <li><a href="/stop/<%= jmx.id %>" style="width:100%; text-align: center;">stop</a></li>
                                                        <% } %>
                                                        
                                                          <li><a href="/view/<%= jmx.id %>" target="_blank" style="width:100%; text-align: center;">view</a></li>
                                                        </ul>
                                                      </div>
											</td>
											<td>
												<a href="#editModal<%= jmx.id %>" class="edit" data-toggle="modal">
													<i class="material-icons" data-toggle="tooltip" title="Edit">edit</i>
												</a>
												<a href="#deleteModal<%= jmx.id %>" class="delete" data-toggle="modal">
													<i class="material-icons" data-toggle="tooltip" title="Delete">delete</i>
                                                </a>
                                                <a href="#chartModal<%= jmx.id %>" class="performance" data-toggle="modal">
													<i class="material-icons" data-toggle="tooltip" title="performance">bar_chart</i>
                                                </a>
                                                
												<div id="editModal<%= jmx.id %>" class="modal fade">
													<div class="modal-dialog">
														<div class="modal-content">
															<form action="/edit/<%= jmx.id %>" method="post" enctype='multipart/form-data' onsubmit="return CheckJmx(this);">
																<div class="modal-header">
																	<h4 class="modal-title">Edit </h4>
																	<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
																</div>
																<div class="modal-body">
                                                                        
                                                                    <div class="form-group">
                                                                        <label>Name</label>
                                                                        <input type="hidden" name="id" value="<%= jmx.id %>">
                                                                        <input type="text" name="name" class="form-control" value="<%= jmx.name %>" readonly>
                                                                        <input type="hidden" name="rightname" class="form-control" value="<%= jmx.name %>">
																	</div>
																	<div class="form-group">
																		<label>File</label>
                                                                        <input id="file<%= jmx.id %>" type="file" name="files" style="display:none" value="<%= jmx.file %>" multiple>
                                                                        <div class="input-append">
                                                                            <input id="uploadfile<%= jmx.id %>" class="form-control" type="text" name="filename" value="<%= jmx.file %>" style="width:70%">
                                                                            <a class="btn btn-info" onclick="$('input[id=file<%= jmx.id %>]').click();" style="float:right;margin-top:-34px; width: 30%">Browse</a>
                                                                        </div>
                                                                        <script type="text/javascript">
                                                                            $('input[id=file<%= jmx.id %>]').change(function () {
                                                                                var files = $(this)[0].files;
                                                                                var num = 0;
                                                                                var value = []
                                                                                for(var i=0;i<files.length;i++){
                                                                                    file = files[i]
                                                                                    if(file.name.endsWith(".jmx")){
                                                                                        num++;
                                                                                    }else{
                                                                                        console.log("other files")
                                                                                    }
                                                                                    value.push(file.name)
                                                                                }
                                                                                if(num!=1){
                                                                                    alert("only need 1 jmx file")
                                                                                }else{
                                                                                    $('#uploadfile<%= jmx.id %>').val(strLenCut(value.join(','),30));
                                                                                }
                                                                            });
                                                                        </script>
																	</div>
																</div>
																<div class="modal-footer">
																	<input type="button" class="btn btn-default" data-dismiss="modal" value="Cancel">
																	<input type="submit" class="btn btn-info" value="Save">
																</div>
															</form>
														</div>
													</div>
												</div>
												<div id="deleteModal<%= jmx.id %>" class="modal fade">
													<div class="modal-dialog">
														<div class="modal-content">
															<form action="/delete/<%= jmx.id %>" method="POST">
																<div class="modal-header">
																	<h4 class="modal-title">Delete Jmx File</h4>
																	<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
																</div>
																<div class="modal-body">
																	<p>Are you sure you want to delete these Files?</p>
																	<p class="text-warning">
																		<small>This action cannot be undone.</small>
																	</p>
																</div>
																<div class="modal-footer">
																	<input type="button" class="btn btn-default" data-dismiss="modal" value="Cancel">
																	<input type="submit" class="btn btn-danger" value="Delete">
																	<input type="hidden" name="_method" value="DELETE" />
																</div>
															</form>
														</div>
													</div>
                                                </div>
                                                <div id="chartModal<%= jmx.id %>" class="modal fade">
													<div class="modal-dialog">
														<div class="modal-content">
                                                                
															<form id="chart<%= jmx.id %>" action="/editchart/<%= jmx.id %>" method="post" enctype='multipart/form-data' onsubmit="return CheckChart(this);">
																<div class="modal-header">
																	<h4 class="modal-title">Performance monitoring</h4>
																	<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
																</div>
																<div class="modal-body">
                                                                    <div class="form-group">
                                                                        <label>ip</label>
																		<input type="text" id="ip<%= jmx.id %>" name="ip" class="form-control" value="<%= jmx.ip %>" readonly>
                                                                    </div>
                                                                    <div class="form-group">
                                                                        <label>user</label>
																		<input type="text" id="user<%= jmx.id %>" name="user" class="form-control" value="<%= jmx.user %>">
                                                                    </div>
                                                                    <div class="form-group">
                                                                        <label>pw</label>
                                                                        <input type="text" id="pw<%= jmx.id %>" name="pw" class="form-control" value="<%= jmx.pw %>">
                                                                        <input type="hidden" id="rightpw<%= jmx.id %>" name="rightpw" class="form-control" value="<%= jmx.pw %>">
                                                                    </div>
                                                                    <div class="form-group">
                                                                        <label>process</label>
																		<input type="text" id="process<%= jmx.id %>" name="process" class="form-control" value="<%= jmx.process %>">
                                                                        <input type="hidden" id="rightpro<%= jmx.id %>" name="rightpro" class="form-control" value="<%= jmx.process %>">
                                                                    </div>
                                                                    <div class="form-group">
                                                                        <label>pid</label>
																		<input type="text" id="pid<%= jmx.id %>" name="pid" class="form-control" value="<%= jmx.pid %>">
                                                                    </div>
                                                                    <div class="form-group">
                                                                        <label>duration</label>
																		<input type="text" id="duration<%= jmx.id %>" name="duration" class="form-control" value="<%= jmx.duration %>" readonly>
                                                                        <input type="hidden" id="status<%= jmx.id %>" name="status" class="form-control" value="<%= jmx.status %>" readonly>
                                                                    </div>
                                                                    <script>
                                                                        $('input[id=user<%= jmx.id %>]').change(function () {
                                                                            console.log('user')
                                                                            if ($('#status<%= jmx.id %>').val() == 'wrong') {
                                                                                alert("jmx file is wrong!")
                                                                            } else {
                                                                                if ($('#user<%= jmx.id %>').val() != "" && $('#pw<%= jmx.id %>').val() != "") {
                                                                                    console.log($('#rightpw<%= jmx.id %>').val())
                                                                                    $('#rightpw<%= jmx.id %>').val("")
                                                                                    console.log($('#rightpw<%= jmx.id %>').val())
                                                                                    rightpw($('form[id=chart<%= jmx.id %>]')[0]);
                                                                                } else {
                                                                                    console.log('can not be empty')
                                                                                }
                                                                            }
                                                                        });
                                                                        $('input[id=pw<%= jmx.id %>]').change(function () {
                                                                            console.log('pw')
                                                                            if ($('#status<%= jmx.id %>').val() == 'wrong') {
                                                                                alert("jmx file is wrong!")
                                                                            } else {
                                                                                if ($('#user<%= jmx.id %>').val() != "" && $('#pw<%= jmx.id %>').val() != "") {
                                                                                    console.log($('#rightpw<%= jmx.id %>').val())
                                                                                    $('#rightpw<%= jmx.id %>').val("")
                                                                                    console.log($('#rightpw<%= jmx.id %>').val())
                                                                                    rightpw($('form[id=chart<%= jmx.id %>]')[0]);
                                                                                } else {
                                                                                    console.log('can not be empty')
                                                                                }
                                                                            }
                                                                        });
                                                                        $('input[id=process<%= jmx.id %>]').change(function () {
                                                                            console.log('process')
                                                                            if ($('#status<%= jmx.id %>').val() == 'wrong') {
                                                                                alert("jmx file is wrong!")
                                                                            } else {
                                                                                if ($('#process<%= jmx.id %>').val() != "") {
                                                                                    if ($('#rightpw<%= jmx.id %>').val() != "") {
                                                                                        console.log($('#rightpro<%= jmx.id %>').val())
                                                                                        $('#rightpro<%= jmx.id %>').val("")
                                                                                        console.log($('#rightpro<%= jmx.id %>').val())
                                                                                        rightpro($('form[id=chart<%= jmx.id %>]')[0]);
                                                                                    } else {
                                                                                        alert('Authentication failed')
                                                                                    }
                                                                                } else {
                                                                                    console.log('can not be empty')
                                                                                }
                                                                            }
                                                                        });
                                                                    </script>
																</div>
																<div class="modal-footer">
																	<input type="button" class="btn btn-default" data-dismiss="modal" value="Cancel">
																	<input type="submit" class="btn btn-info" value="Save">
																</div>
															</form>
														</div>
													</div>
												</div>
											</td>
											
										</tr>
										<% }) %>
											<% } %>
							</tbody>
						</table>
						<div class="clearfix">
							<div class="hint-text">Showing
								<b><%= data.length %></b> out of
								<b>All</b> Files</div>
							<ul class="pagination">
                                <li class="page-item disabled">
                                    <% if (id == 1) { %>
                                        <a href="javascript:void(0)" class="page-link disabled">Previous</a>
                                    <%} else{%>
                                        <a href="/<%= id-1 %>" class="page-link">Previous</a>
                                    <%}%>
                                </li>
                                
                                <%if(data.length<20){end=id-0}else{end=id-0+1}%>
                                <% for(var i=id-3;i<=end;i++){%>
                                    <%if (i>0){%>
                                    <li class="page-item <%if (i==id){%>active<%}%>">
                                        <a href="<%if (i==id){%>javascript:void(0)<%}else{%>/<%= i %><%}%>" class="page-link"><%= i %></a>
                                    </li>
                                    <%}%>
                                <%} %>

                                <li class="page-item disabled">
                                    <% if (data.length<20) { %>   
                                        <a href="javascript:void(0)" class="page-link disabled">Next</a>
                                    <%} else{%>
                                        <a href="/<%= id-0+1 %>" class="page-link">Next</a>
                                    <%}%>
                                </li>
							</ul>
						</div>
                    </div>
					<%- include jmxs/add.ejs %>
                    <%- include jmxs/delete.ejs %>

					<%- include layouts/footer.ejs %>